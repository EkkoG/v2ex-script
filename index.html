<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <link rel="icon" href="/favicon.ico"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.2.40/vue.global.js"></script>
    <title>Vite App</title>
</head>
<body>
<div id="app"></div>
<script>
    // console.log(window.top[0])
    // window.win = () => window

    if (window.top[0]) {
        window.win = () => window.top
        window.url = 'https://www.v2ex.com'
        // window.url = location.origin
        window.isFrame = true
    } else {
        window.win = () => window
        window.url = 'https://www.v2ex.com'
        // window.url = location.origin
        window.isFrame = false
        // let location = window.win().location
        // console.log(location)
    }
    window.doc = window.win().document
    window.user = {}
    let location2 = window.win().location
    window.type = 'home'
    window.pageData = {}
    if (location2.pathname) {
        let r = location2.pathname.match(/t\/([\d]+)/)
        if (r) {
            window.type = 'post'
            window.pageData.id = r[1]
            if (location2.search) {
                let pr = location2.search.match(/\?p=([\d]+)/)
                if (pr) window.pageData.pageNo = Number(pr[1])
            }
        }
    }

    console.log('type===', window.type, 'pageData===', window.pageData)

    //let $vue = document.createElement('iframe');$vue.src = 'http://localhost:3000/';document.body.appendChild($vue);
    if (window.top.document !== window.document && !window.isFrame) {
        if (!window.win().init) {
            window.win().init = true

            window.win().cb = null
            let $section = document.createElement('section')
            $section.id = 'app'
            let box = $('#Wrapper #Main .box:first', window.doc)
            let href = window.win().location.href
            let r = href.match(/t\/([\d]+)/)
            if (r) {
                box.after($section)
            } else {
                box.css({background: 'transparent', 'box-shadow': 'unset'})
                let wrapper = box.find('.item:first')
                wrapper.after($section)

                let list = []
                let apiList = []
                let listItemNode = doc.querySelectorAll('.item',)
                // listItemNode = Array.from(listItemNode)
                // listItemNode.slice(1, 5).forEach(itemNode => {
                listItemNode.forEach(itemNode => {
                    let item = {replies: []}
                    let bg = itemNode.style['background-image']
                    item.bg = bg
                    let item_title = itemNode.querySelector('.item_title a')
                    let href = item_title.href
                    item.id = href.substring(href.indexOf('/t/') + 3, href.indexOf('#'))
                    item.title = item_title.innerText

                    let topic_info = itemNode.querySelector('.topic_info')
                    let userNode = topic_info.querySelector('strong a')
                    item.username = userNode.innerText
                    let timeNode = itemNode.querySelector('.topic_info span')
                    item.date = timeNode.innerText
                    let tagNode = topic_info.querySelector('.node')
                    item.node = tagNode.innerText
                    let countNode = itemNode.querySelector('.count_livid')
                    item.replyCount = countNode ? countNode.innerText : 0
                    itemNode.remove()

                    let url = window.win().location.origin + '/api/topics/show.json?id=' + item.id
                    // console.log(url)
                    apiList.push($.get(url))
                    list.push(item)
                })
                window.win().postList = list
                console.log(list)

                let count = 0

                async function sleep(time) {
                    return new Promise(resolve => {
                        console.log('等待vue加载完成,第' + count + '次', Date.now())
                        setTimeout(resolve, time)
                    })
                }

                Promise.allSettled(apiList).then(
                    async (results) => {
                        let res = results.filter((result) => result.status === "fulfilled").map(v => v.value[0])
                        if (window.win().cb) {
                            window.win().cb(res)
                        } else {
                            while ((!window.win().cb) && count < 20) {
                                await sleep(500)
                                count++
                            }
                            window.win().cb && window.win().cb(res)
                        }
                    }
                );
            }
        }


        //开发时自动更新window.top head里面添加的vue style
        function getStyle(html) {
            let reg = html.match(/(<title>Vite App<\/title>[\s\S]+)/g)
            if (reg) {
                return reg[0]
            }
            return `<style></style>`
        }

        function removeVueStyle() {
            let title = $('title:eq(1)', window.doc.head)
            while (title.next().length) {
                title.next().remove()
            }
            title.remove()
        }

        window.onbeforeunload = removeVueStyle

        let observe = new MutationObserver(() => {
            removeVueStyle()

            let headHtml = window.document.head.innerHTML
            let reg = getStyle(headHtml)
            $(window.doc.head).append($(`<head>${reg}</head>`))
        });
        observe.observe(window.document.head, {
            attributes: true, //目标节点的属性变化
            childList: true, //目标节点的子节点的新增和删除
            characterData: true, //如果目标节点为characterData节点(一种抽象接口,具体可以为文本节点,注释节点,以及处理指令节点)时,也要观察该节点的文本内容是否发生变化
            subtree: true, //目标节点所有后代节点的attributes、childList、characterData变化
        });// 后面介绍config的配置

    }
</script>
<script type="module" src="/src/main.js"></script>
</body>
</html>
